<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Harpia Pro - Sistema Avan√ßado de Vendas</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .login-modal { background: #fff; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,.3); text-align: center; max-width: 420px; width: 92%; }
    .login-modal h2 { color: #667eea; margin-bottom: 8px; font-size: 1.8rem; }
    .login-form { display: flex; flex-direction: column; gap: 14px; margin-top: 10px; }
    .login-input { padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; }
    .login-input:focus { outline: none; border-color: #667eea; }
    .role-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 8px 0 6px; }
    .role-btn { padding: 14px; border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer; transition: .25s; background: #fff; font-weight: 600; }
    .role-btn:hover { border-color: #667eea; }
    .role-btn.active { border-color: #667eea; background: #f0f4ff; color: #667eea; }

    .container { max-width: 1600px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,.1); overflow: hidden; display: none; }
    .container.active { display: block; }
    .header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 26px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .header-left h1 { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
    .user-info { display: flex; align-items: center; gap: 14px; background: rgba(255,255,255,.12); padding: 10px 16px; border-radius: 25px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,.22); display: grid; place-items: center; font-weight: 700; }
    .permission-badge { background: #e8f5e8; color: #388e3c; padding: 3px 8px; border-radius: 12px; font-size: .75rem; font-weight: 700; margin-left: 8px; }
    .permission-editor { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }

    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 18px; padding: 24px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .stat-card { background: #fff; padding: 22px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,.06); text-align: center; position: relative; overflow: hidden; }
    .stat-card::before { content: ""; position: absolute; left: 0; right: 0; top: 0; height: 4px; background: linear-gradient(90deg,#667eea,#764ba2); }
    .stat-number { font-size: 2.2rem; font-weight: 800; color: #667eea; display: block; margin-bottom: 6px; }
    .stat-label { color: #6c757d; font-weight: 700; font-size: .92rem; }
    .stat-change { font-size: .8rem; margin-top: 8px; padding: 4px 8px; border-radius: 12px; font-weight: 700; display: inline-block; }
    .stat-up { background: #d4edda; color: #155724; }
    .stat-down { background: #f8d7da; color: #721c24; }

    .controls { padding: 18px 24px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; flex-wrap: wrap; gap: 12px; justify-content: space-between; }
    .controls-left { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 12px 20px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 700; transition: .25s; display: inline-flex; align-items: center; gap: 8px; font-size: .92rem; text-decoration: none; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,.3); }
    .btn-success { background: linear-gradient(135deg,#28a745,#20c997); color: #fff; }
    .btn-warning { background: linear-gradient(135deg,#ffc107,#fd7e14); color: #212529; }
    .btn-info { background: linear-gradient(135deg,#17a2b8,#6f42c1); color: #fff; }
    .search-box, .filter-select { padding: 10px 14px; border: 2px solid #e9ecef; border-radius: 10px; background: #fff; font-size: .92rem; }
    .search-box { border-radius: 24px; min-width: 250px; }
    .table-container { overflow-x: auto; max-height: 600px; background: #fff; }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    th { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; padding: 16px 14px; text-align: left; font-weight: 700; font-size: .9rem; position: sticky; top: 0; z-index: 5; cursor: pointer; user-select: none; }
    th:hover { filter: brightness(1.03); }
    td { padding: 14px; border-bottom: 1px solid #e9ecef; font-size: .86rem; vertical-align: middle; }
    tr:hover { background: #f8f9fa; }

    .status { padding: 6px 12px; border-radius: 20px; font-size: .8rem; font-weight: 700; min-width: 90px; display: inline-block; text-align: center; }
    .status-novo { background:#e3f2fd; color:#1976d2; }
    .status-contato { background:#fff3e0; color:#f57c00; }
    .status-interessado { background:#e8f5e8; color:#388e3c; }
    .status-proposta { background:#f3e5f5; color:#7b1fa2; }
    .status-negociacao { background:#fff8e1; color:#f9a825; }
    .status-fechado { background:#e1f5fe; color:#0277bd; }
    .status-perdido { background:#ffebee; color:#d32f2f; }

    .priority { padding: 4px 10px; border-radius: 12px; font-size: .75rem; font-weight: 700; }
    .priority-alta { background:#ffcdd2; color:#c62828; }
    .priority-media { background:#fff3e0; color:#ef6c00; }
    .priority-baixa { background:#e8f5e8; color:#2e7d32; }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .btn-small { padding: 6px 10px; font-size: .75rem; border-radius: 6px; border: none; cursor: pointer; transition: .2s; display: inline-flex; align-items: center; gap: 4px; }
    .btn-edit { background:#17a2b8; color:#fff; }
    .btn-delete { background:#dc3545; color:#fff; }
    .btn-whatsapp { background:#25d366; color:#fff; }
    .btn-email { background:#6c757d; color:#fff; }
    .btn-call { background:#007bff; color:#fff; }

    .add-lead { position: fixed; bottom: 26px; right: 26px; width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; border: none; font-size: 1.6rem; cursor: pointer; box-shadow: 0 10px 25px rgba(102,126,234,.4); transition: .25s; z-index: 1000; display: grid; place-items: center; }
    .add-lead:hover { transform: scale(1.08) translateY(-2px); box-shadow: 0 15px 35px rgba(102,126,234,.5); }

    .notes { max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .contact-info { display: flex; flex-direction: column; gap: 4px; }
    .contact-detail { font-size: .8rem; color: #6c757d; display: flex; align-items: center; gap: 4px; }
    .company-info { font-weight: 700; color: #2d3748; margin-bottom: 2px; }
    .sector { font-size: .78rem; color: #6c757d; background: #f8f9fa; padding: 2px 8px; border-radius: 10px; display: inline-block; }
    .last-contact { font-size: .75rem; color: #28a745; font-weight: 800; }
    .overdue { color: #dc3545 !important; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 26px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,.3); max-width: 520px; width: 92%; max-height: 82vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid #e9ecef; }
    .modal-title { font-size: 1.4rem; color: #667eea; font-weight: 800; }
    .modal-close { background: none; border: none; font-size: 1.6rem; cursor: pointer; color: #6c757d; padding: 4px; }

    .form-group { margin-bottom: 14px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 800; color: #2d3748; }
    .form-input { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: .92rem; }
    .form-input:focus { outline: none; border-color: #667eea; }
    .form-textarea { min-height: 100px; resize: vertical; }

    @media (max-width: 768px) {
      .header { flex-direction: column; text-align: center; }
      .controls { flex-direction: column; align-items: stretch; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      th, td { font-size: .78rem; padding: 10px 8px; }
      .add-lead { bottom: 18px; right: 18px; }
      .search-box { min-width: 200px; }
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-modal">
      <h2>üöÄ CRM Harpia Pro</h2>
      <p style="margin-bottom: 14px; color:#6c757d">Acesso ao sistema de vendas</p>
      <div class="login-form">
        <input type="text" class="login-input" id="username" placeholder="Nome de usu√°rio" />
        <div class="role-selector">
          <div class="role-btn active" id="roleReaderBtn" onclick="selectRole('reader')">
            <div>üëÄ <strong>Leitor</strong></div>
            <div style="font-size:.8rem; margin-top:5px;">Visualizar apenas</div>
          </div>
          <div class="role-btn" id="roleEditorBtn" onclick="selectRole('editor')">
            <div>‚úèÔ∏è <strong>Editor</strong></div>
            <div style="font-size:.8rem; margin-top:5px;">Editar tudo</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="login()" style="padding: 15px;">Entrar no Sistema</button>
      </div>
      <div style="margin-top: 16px; font-size:.82rem; color:#6c757d">
        <strong>Usu√°rios de teste:</strong><br/>Editor: admin, joao, vendedor<br/>Leitor: estagiario, assistente, suporte
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="container" id="mainContainer">
    <div class="header">
      <div class="header-left">
        <h1>üöÄ CRM Harpia Pro</h1>
        <p>Sistema Avan√ßado de Gest√£o de Vendas</p>
      </div>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">J</div>
        <div>
          <div style="font-weight: 800;" id="userName">Jo√£o Silva</div>
          <div style="font-size: .82rem; opacity: .9">
            <span id="userRole">Editor</span>
            <span class="permission-badge permission-editor" id="permissionBadge">EDITOR</span>
          </div>
        </div>
        <button class="btn" onclick="logout()" style="background: rgba(255,255,255,.2); color:#fff; padding: 8px 14px;">üö™ Sair</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><span class="stat-number" id="total-leads">0</span><div class="stat-label">Total de Leads</div><div class="stat-change stat-up" id="leads-change">‚Äî</div></div>
      <div class="stat-card"><span class="stat-number" id="interessados">0</span><div class="stat-label">Interessados</div><div class="stat-change stat-up" id="interested-change">‚Äî</div></div>
      <div class="stat-card"><span class="stat-number" id="propostas">0</span><div class="stat-label">Propostas Enviadas</div><div class="stat-change stat-up" id="proposals-change">‚Äî</div></div>
      <div class="stat-card"><span class="stat-number" id="fechados">0</span><div class="stat-label">Vendas Fechadas</div><div class="stat-change stat-up" id="closed-change">‚Äî</div></div>
      <div class="stat-card"><span class="stat-number" id="taxa-conversao">0%</span><div class="stat-label">Taxa de Convers√£o</div><div class="stat-change stat-down" id="conversion-change">‚Äî</div></div>
    </div>

    <div class="controls">
      <div class="controls-left">
        <input type="text" class="search-box" placeholder="üîç Buscar por nome, empresa ou telefone..." onkeyup="searchLeads(this.value)" />
        <select class="filter-select" onchange="filterByStatus(this.value)">
          <option value="todos">üìä Todos os Status</option>
          <option value="novo">üÜï Novo</option>
          <option value="contato">üìû Primeiro Contato</option>
          <option value="interessado">‚ú® Interessado</option>
          <option value="proposta">üìã Proposta Enviada</option>
          <option value="negociacao">üí¨ Negocia√ß√£o</option>
          <option value="fechado">‚úÖ Fechado</option>
          <option value="perdido">‚ùå Perdido</option>
        </select>
        <select class="filter-select" onchange="filterBySector(this.value)">
          <option value="todos">üè¢ Todos os Setores</option>
          <option value="restaurante">üçΩÔ∏è Restaurante</option>
          <option value="ecommerce">üõí E-commerce</option>
          <option value="servicos">üîß Servi√ßos</option>
          <option value="consultoria">üíº Consultoria</option>
          <option value="beleza">üíÑ Beleza</option>
          <option value="fitness">üí™ Fitness</option>
          <option value="saude">üè• Sa√∫de</option>
        </select>
      </div>
      <div class="controls-right">
        <button class="btn btn-info" onclick="showStats()">üìà Relat√≥rios</button>
        <button class="btn btn-warning" onclick="sendFollowUps()">üì± Follow-ups Hoje (<span id="followup-count">0</span>)</button>
        <button class="btn btn-primary" onclick="exportToExcel()">üìä Exportar Excel</button>
      </div>
    </div>

    <div class="table-container">
      <table id="leadsTable">
        <thead>
          <tr>
            <th onclick="sortTable('nome')">üë§ Nome</th>
            <th onclick="sortTable('empresa')">üè¢ Empresa</th>
            <th onclick="sortTable('contato')">üìû Contato</th>
            <th onclick="sortTable('status')">üìä Status</th>
            <th onclick="sortTable('proximoPasso')">‚è≠Ô∏è Pr√≥ximo Passo</th>
            <th onclick="sortTable('prioridade')">‚ö° Prioridade</th>
            <th onclick="sortTable('valorPotencial')">üí∞ Valor</th>
            <th onclick="sortTable('dataFollowUp')">üìÖ Follow-up</th>
            <th onclick="sortTable('ultimoContato')">üïí √öltimo Contato</th>
            <th>üìù Observa√ß√µes</th>
            <th>üîß A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody"></tbody>
      </table>
    </div>
  </div>

  <button class="add-lead" id="addLeadBtn" onclick="openLeadModal()">+</button>

  <!-- Modal Lead -->
  <div class="modal" id="leadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">‚ûï Novo Lead</h3>
        <button class="modal-close" onclick="closeLeadModal()">&times;</button>
      </div>
      <form id="leadForm" onsubmit="event.preventDefault(); saveLead();">
        <input type="hidden" id="leadId" />
        <div class="form-group"><label class="form-label">üë§ Nome do Contato *</label><input type="text" class="form-input" id="leadNome" required /></div>
        <div class="form-group"><label class="form-label">üè¢ Empresa *</label><input type="text" class="form-input" id="leadEmpresa" required /></div>
        <div class="form-group"><label class="form-label">üì± Telefone *</label><input type="tel" class="form-input" id="leadTelefone" placeholder="+34 666 123 456" required /></div>
        <div class="form-group"><label class="form-label">üìß Email</label><input type="email" class="form-input" id="leadEmail" /></div>
        <div class="form-group"><label class="form-label">üè¢ Setor</label>
          <select class="form-input" id="leadSetor">
            <option value="restaurante">üçΩÔ∏è Restaurante</option>
            <option value="ecommerce">üõí E-commerce</option>
            <option value="servicos">üîß Servi√ßos</option>
            <option value="consultoria">üíº Consultoria</option>
            <option value="beleza">üíÑ Beleza</option>
            <option value="fitness">üí™ Fitness</option>
            <option value="saude">üè• Sa√∫de</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">üìä Status</label>
          <select class="form-input" id="leadStatus">
            <option value="novo">üÜï Novo</option>
            <option value="contato">üìû Primeiro Contato</option>
            <option value="interessado">‚ú® Interessado</option>
            <option value="proposta">üìã Proposta Enviada</option>
            <option value="negociacao">üí¨ Negocia√ß√£o</option>
            <option value="fechado">‚úÖ Fechado</option>
            <option value="perdido">‚ùå Perdido</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">‚ö° Prioridade</label>
          <select class="form-input" id="leadPrioridade">
            <option value="baixa">üü¢ Baixa</option>
            <option value="media">üü° M√©dia</option>
            <option value="alta">üî¥ Alta</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">üí∞ Valor Potencial</label><input type="text" class="form-input" id="leadValor" value="‚Ç¨497" /></div>
        <div class="form-group"><label class="form-label">üìÖ Data Follow-up</label><input type="date" class="form-input" id="leadFollowUp" /></div>
        <div class="form-group"><label class="form-label">‚è≠Ô∏è Pr√≥ximo Passo</label><input type="text" class="form-input" id="leadProximoPasso" placeholder="Ex: Enviar proposta personalizada" /></div>
        <div class="form-group"><label class="form-label">üìù Observa√ß√µes</label><textarea class="form-input form-textarea" id="leadObservacoes" placeholder="Detalhes importantes sobre o lead..."></textarea></div>
        <div style="display:flex; gap: 10px; justify-content: flex-end; margin-top: 18px;">
          <button type="button" class="btn" onclick="closeLeadModal()" style="background:#6c757d; color:#fff">‚ùå Cancelar</button>
          <button type="submit" class="btn btn-success">üíæ Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== Estado Global =====
    let selectedRole = 'reader';
    let leads = [];
    let filters = { text: '', status: 'todos', setor: 'todos' };
    let sortState = { field: 'nome', dir: 'asc' };

    // ===== Utils =====
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const moneyToNumber = (v) => Number(String(v).replace(/[^0-9,.]/g,'').replace('.', '').replace(',', '.')) || 0;
    const numberToMoney = (n) => new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(n || 0);

    function saveToStorage(){ localStorage.setItem('harpia_leads', JSON.stringify(leads)); }
    function loadFromStorage(){ try { leads = JSON.parse(localStorage.getItem('harpia_leads')||'[]'); } catch { leads = []; } }

    function seedIfEmpty(){
      if(leads.length) return;
      leads = [
        { id: cid(), nome:'Maria Costa', empresa:'Costa Bistr√¥', setor:'restaurante', contato:'+34 600 111 222', email:'maria@costa.com', status:'interessado', proximoPasso:'Enviar proposta', prioridade:'alta', valorPotencial: 1297, dataFollowUp: dateIn(1), ultimoContato: dateIn(-2), observacoes:'Quer plano anual com 2 licen√ßas.' },
        { id: cid(), nome:'Jo√£o Mendes', empresa:'FitPrime', setor:'fitness', contato:'+34 600 333 444', email:'joao@fitprime.es', status:'contato', proximoPasso:'Marcar call', prioridade:'media', valorPotencial: 497, dataFollowUp: dateIn(0), ultimoContato: dateIn(-1), observacoes:'Chegou via indica√ß√£o.' },
        { id: cid(), nome:'Luna Tech', empresa:'LunaShop', setor:'ecommerce', contato:'+34 600 555 666', email:'contato@lunashop.es', status:'negociacao', proximoPasso:'Revisar cl√°usulas', prioridade:'alta', valorPotencial: 2497, dataFollowUp: dateIn(3), ultimoContato: dateIn(-5), observacoes:'Precisa integra√ß√£o ERP.' },
        { id: cid(), nome:'Dr. P√©rez', empresa:'Cl√≠nica P√©rez', setor:'saude', contato:'+34 600 777 888', email:'drperez@clinica.es', status:'fechado', proximoPasso:'Onboarding', prioridade:'baixa', valorPotencial: 1491, dataFollowUp: '', ultimoContato: dateIn(-7), observacoes:'Contrato assinado.' },
        { id: cid(), nome:'Studio Bella', empresa:'Bella Spa', setor:'beleza', contato:'+34 600 999 000', email:'contato@bellaspa.es', status:'novo', proximoPasso:'Enviar cat√°logo', prioridade:'media', valorPotencial: 297, dataFollowUp: dateIn(2), ultimoContato: '', observacoes:'Interessados em pacote starter.' },
      ];
      saveToStorage();
    }

    function cid(){ return 'L'+Math.random().toString(36).slice(2,10); }
    function dateIn(days){ const d = new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

    // ===== Login / Logout =====
    function selectRole(role){
      selectedRole = role;
      $('#roleReaderBtn').classList.toggle('active', role==='reader');
      $('#roleEditorBtn').classList.toggle('active', role==='editor');
    }

    function login(){
      const username = $('#username').value.trim();
      if(!username){ alert('Digite um nome de usu√°rio!'); return; }
      $('#loginOverlay').style.display = 'none';
      $('#mainContainer').classList.add('active');

      $('#userName').innerText = username;
      $('#userAvatar').innerText = username.charAt(0).toUpperCase();
      const isEditor = selectedRole === 'editor' || ['admin','joao','vendedor'].includes(username.toLowerCase());
      selectedRole = isEditor ? 'editor' : 'reader';
      $('#userRole').innerText = isEditor ? 'Editor' : 'Leitor';
      const badge = $('#permissionBadge');
      badge.innerText = selectedRole.toUpperCase();
      badge.classList.toggle('permission-editor', isEditor);

      // Habilitar/Desabilitar a√ß√µes
      $('#addLeadBtn').style.display = isEditor ? 'grid' : 'none';
      render();
    }

    function logout(){
      $('#mainContainer').classList.remove('active');
      $('#loginOverlay').style.display = 'flex';
      $('#username').value = '';
    }

    // ===== Filtros, Busca e Ordena√ß√£o =====
    function searchLeads(text){ filters.text = (text||'').toLowerCase(); renderTable(); }
    function filterByStatus(status){ filters.status = status; renderTable(); }
    function filterBySector(setor){ filters.setor = setor; renderTable(); }

    function sortTable(field){
      if(sortState.field === field){ sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc'; }
      else { sortState.field = field; sortState.dir = 'asc'; }
      renderTable();
    }

    // ===== A√ß√µes de Bot√µes Superiores =====
    function showStats(){
      const total = leads.length;
      const interessados = leads.filter(l=>l.status==='interessado').length;
      const propostas = leads.filter(l=>l.status==='proposta').length;
      const fechados = leads.filter(l=>l.status==='fechado').length;
      const totalValor = leads.reduce((s,l)=>s+(l.status==='fechado'? (l.valorPotencial||0):0),0);
      alert(`üìà Relat√≥rio R√°pido\n\nLeads: ${total}\nInteressados: ${interessados}\nPropostas: ${propostas}\nFechados: ${fechados}\nFaturado: ${numberToMoney(totalValor)}`);
    }

    function sendFollowUps(){
      const hoje = new Date().toISOString().slice(0,10);
      const lista = leads.filter(l=> l.dataFollowUp && l.dataFollowUp <= hoje && l.status !== 'fechado' && l.status !== 'perdido');
      if(!lista.length){ alert('Nenhum follow-up pendente para hoje.'); return; }
      const nomes = lista.map(l=>`‚Ä¢ ${l.nome} (${l.empresa}) - ${l.contato}`).join('\n');
      alert(`üì± Follow-ups de hoje:\n\n${nomes}`);
    }

    function exportToExcel(){
      const rows = [
        ['Nome','Empresa','Setor','Contato','Email','Status','Pr√≥ximo Passo','Prioridade','Valor (‚Ç¨)','Follow-up','√öltimo Contato','Observa√ß√µes']
      ];
      filteredAndSorted().forEach(l=>{
        rows.push([l.nome,l.empresa,l.setor,l.contato,l.email,l.status,l.proximoPasso,l.prioridade,String(l.valorPotencial).replace('.',','),l.dataFollowUp,l.ultimoContato,l.observacoes]);
      });
      const csv = rows.map(r=> r.map(v => '"'+String(v??'').replace(/"/g,'""')+'"').join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'crm_harpia_export.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    // ===== CRUD Leads =====
    function openLeadModal(id){
      const isEditor = selectedRole==='editor';
      if(!isEditor){ alert('Modo Leitor: edi√ß√£o desativada.'); return; }
      $('#leadModal').classList.add('active');
      if(id){
        const l = leads.find(x=>x.id===id); if(!l) return;
        $('#modalTitle').innerText = '‚úèÔ∏è Editar Lead';
        $('#leadId').value = l.id;
        $('#leadNome').value = l.nome;
        $('#leadEmpresa').value = l.empresa;
        $('#leadTelefone').value = l.contato;
        $('#leadEmail').value = l.email||'';
        $('#leadSetor').value = l.setor||'servicos';
        $('#leadStatus').value = l.status||'novo';
        $('#leadPrioridade').value = l.prioridade||'media';
        $('#leadValor').value = numberToMoney(l.valorPotencial).replace('‚Ç¨','‚Ç¨');
        $('#leadFollowUp').value = l.dataFollowUp||'';
        $('#leadProximoPasso').value = l.proximoPasso||'';
        $('#leadObservacoes').value = l.observacoes||'';
      } else {
        $('#modalTitle').innerText = '‚ûï Novo Lead';
        $('#leadForm').reset();
        $('#leadId').value = '';
        $('#leadValor').value = '‚Ç¨497';
      }
    }

    function closeLeadModal(){ $('#leadModal').classList.remove('active'); }

    function saveLead(){
      const id = $('#leadId').value || cid();
      const obj = {
        id,
        nome: $('#leadNome').value.trim(),
        empresa: $('#leadEmpresa').value.trim(),
        setor: $('#leadSetor').value,
        contato: $('#leadTelefone').value.trim(),
        email: $('#leadEmail').value.trim(),
        status: $('#leadStatus').value,
        proximoPasso: $('#leadProximoPasso').value.trim(),
        prioridade: $('#leadPrioridade').value,
        valorPotencial: moneyToNumber($('#leadValor').value),
        dataFollowUp: $('#leadFollowUp').value,
        ultimoContato: new Date().toISOString().slice(0,10),
        observacoes: $('#leadObservacoes').value.trim()
      };
      if(!obj.nome || !obj.empresa || !obj.contato){ alert('Preencha Nome, Empresa e Telefone.'); return; }
      const existingIdx = leads.findIndex(x=>x.id===id);
      if(existingIdx>=0) leads[existingIdx] = obj; else leads.push(obj);
      saveToStorage();
      closeLeadModal();
      render();
    }

    function deleteLead(id){
      if(selectedRole!=='editor'){ alert('Modo Leitor: exclus√£o desativada.'); return; }
      if(!confirm('Tem certeza que deseja excluir este lead?')) return;
      leads = leads.filter(l=>l.id!==id);
      saveToStorage();
      render();
    }

    // ===== Renderiza√ß√£o =====
    function filteredAndSorted(){
      const t = filters.text;
      let out = leads.filter(l => (
        (filters.status==='todos' || l.status===filters.status) &&
        (filters.setor==='todos' || l.setor===filters.setor) &&
        (!t || `${l.nome} ${l.empresa} ${l.contato}`.toLowerCase().includes(t))
      ));
      out.sort((a,b)=>{
        let va = a[sortState.field];
        let vb = b[sortState.field];
        if(sortState.field==='valorPotencial'){ va = +a.valorPotencial; vb = +b.valorPotencial; }
        if(va==null) va=''; if(vb==null) vb='';
        const res = String(va).localeCompare(String(vb), 'pt', { numeric: true, sensitivity:'base' });
        return sortState.dir==='asc' ? res : -res;
      });
      return out;
    }

    function renderStats(){
      $('#total-leads').innerText = leads.length;
      const interessados = leads.filter(l=>l.status==='interessado').length; $('#interessados').innerText = interessados;
      const propostas = leads.filter(l=>l.status==='proposta').length; $('#propostas').innerText = propostas;
      const fechados = leads.filter(l=>l.status==='fechado').length; $('#fechados').innerText = fechados;
      const taxa = leads.length ? Math.round((fechados/leads.length)*1000)/10 : 0; $('#taxa-conversao').innerText = `${taxa}%`;
      const hoje = new Date().toISOString().slice(0,10);
      const followups = leads.filter(l=> l.dataFollowUp && l.dataFollowUp<=hoje && l.status!=='fechado' && l.status!=='perdido').length;
      $('#followup-count').innerText = followups;
    }

    function renderTable(){
      const tbody = $('#leadsTableBody');
      tbody.innerHTML = '';
      filteredAndSorted().forEach(l => {
        const tr = document.createElement('tr');
        const statusClass = `status status-${l.status}`;
        const prioClass = `priority priority-${l.prioridade}`;
        tr.innerHTML = `
          <td>${l.nome}</td>
          <td><div class="company-info">${l.empresa}</div><span class="sector">${l.setor}</span></td>
          <td class="contact-info">
            <span class="contact-detail">${l.contato}</span>
            ${l.email ? `<span class="contact-detail">${l.email}</span>` : ''}
          </td>
          <td><span class="${statusClass}">${l.status}</span></td>
          <td>${l.proximoPasso||''}</td>
          <td><span class="${prioClass}">${l.prioridade}</span></td>
          <td>${numberToMoney(l.valorPotencial)}</td>
          <td>${l.dataFollowUp||''}</td>
          <td><span class="last-contact ${isOverdue(l.ultimoContato)?'overdue':''}">${l.ultimoContato||''}</span></td>
          <td class="notes" title="${(l.observacoes||'').replace(/\"/g,'\"')}">${l.observacoes||''}</td>
          <td>
            <div class="actions">
              <button class="btn-small btn-whatsapp" onclick="openWhatsapp('${l.contato}','${encodeURIComponent('Ol√° ' + l.nome + '! Podemos falar sobre a proposta?')}')">WhatsApp</button>
              ${l.email? `<button class="btn-small btn-email" onclick="mailtoLead('${l.email}','Proposta CRM Harpia','Ol√° ${l.nome}, segue nossa proposta...')">Email</button>`: ''}
              <button class="btn-small btn-call" onclick="callLead('${l.contato}')">Ligar</button>
              ${selectedRole==='editor' ? `<button class=\"btn-small btn-edit\" onclick=\"openLeadModal('${l.id}')\">Editar</button><button class=\"btn-small btn-delete\" onclick=\"deleteLead('${l.id}')\">Excluir</button>`: ''}
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
      renderStats();
    }

    function isOverdue(dateStr){ if(!dateStr) return false; const d = new Date(dateStr); const diff = (Date.now()-d.getTime())/(1000*60*60*24); return diff>7; }

    function render(){ renderTable(); }

    // ===== A√ß√µes r√°pidas =====
    function openWhatsapp(phone, msg){ window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${msg}`, '_blank'); }
    function mailtoLead(email, subject, body){ window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; }
    function callLead(phone){ window.location.href = `tel:${phone.replace(/\D/g,'')}`; }

    // ===== Boot =====
    loadFromStorage();
    seedIfEmpty();
    renderStats();
  </script>
</body>
</html>
